<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline'; img-src data: blob:;">
    <title>Auto Tester</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--vscode-font-family, -apple-system, BlinkMacSystemFont, sans-serif);
            padding: 0;
            color: var(--vscode-foreground);
            background: var(--vscode-sideBar-background);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .message {
            max-width: 90%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
            word-break: break-word;
            white-space: pre-wrap;
        }
        
        .message.agent {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px 12px 12px 4px;
            color: var(--vscode-foreground);
        }
        
        .message.user {
            align-self: flex-end;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--vscode-foreground);
            border-radius: 12px 12px 4px 12px;
        }
        
        .message img {
            max-width: 120px;
            max-height: 80px;
            object-fit: cover;
            border-radius: 6px;
            margin-top: 8px;
            cursor: pointer;
        }
        
        .message img:hover {
            opacity: 0.9;
        }
        
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            color: var(--vscode-descriptionForeground);
            font-size: 12px;
            text-align: center;
        }
        
        .empty-state svg {
            width: 36px;
            height: 36px;
            margin-bottom: 12px;
            opacity: 0.4;
            stroke: var(--vscode-descriptionForeground);
        }
        
        .input-area {
            padding: 12px;
            background: var(--vscode-sideBar-background);
        }
        
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: flex-end;
        }
        
        .input-wrapper.dragover textarea {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }
        
        textarea {
            width: 100%;
            min-height: 44px;
            max-height: 360px;
            padding: 10px 36px 10px 12px;
            font-family: var(--vscode-font-family);
            font-size: 13px;
            line-height: 1.4;
            color: var(--vscode-input-foreground);
            background: var(--vscode-input-background);
            border: 1px solid transparent;
            border-radius: 4px;
            resize: none;
            outline: none;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--vscode-scrollbarSlider-background) transparent;
        }
        
        textarea::-webkit-scrollbar {
            width: 6px;
        }
        
        textarea::-webkit-scrollbar-track {
            background: transparent;
        }
        
        textarea::-webkit-scrollbar-thumb {
            background: var(--vscode-scrollbarSlider-background);
            border-radius: 3px;
        }
        
        textarea:focus {
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        textarea::placeholder {
            color: var(--vscode-input-placeholderForeground);
        }
        
        textarea:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: var(--vscode-input-background);
        }
        
        .send-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .image-preview {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .image-preview-item {
            position: relative;
            max-width: 60px;
        }
        
        .image-preview-item img {
            width: 60px;
            height: 45px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--vscode-input-border);
        }
        
        .image-preview-item .remove-img {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--vscode-errorForeground);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 1;
        }
        
        .send-btn {
            position: absolute;
            right: 6px;
            bottom: 6px;
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            color: var(--vscode-foreground);
            opacity: 0.5;
            transition: all 0.15s ease;
        }
        
        .send-btn svg {
            width: 16px;
            height: 16px;
        }
        
        .send-btn:hover {
            background: var(--vscode-toolbar-hoverBackground);
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="chat" id="chat">
        <div class="empty-state" id="emptyState">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.3 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10.4"/>
                <path d="M8 10h.01"/><path d="M12 10h.01"/><path d="M16 10h.01"/>
                <path d="m17 22 5-3-5-3v6Z"/>
            </svg>
            <div>No requests from agent so far.</div>
        </div>
    </div>
    
    <div class="input-area">
        <div class="input-wrapper" id="inputWrapper">
            <textarea id="input" placeholder="Waiting for request from agent..." rows="1" disabled></textarea>
            <button class="send-btn" id="sendBtn" title="Send" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18-8.5a.5.5 0 0 0 0-.904z"/>
                    <path d="M6 12h16"/>
                </svg>
            </button>
        </div>
        <div class="image-preview" id="imagePreview"></div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        const chat = document.getElementById('chat');
        const emptyState = document.getElementById('emptyState');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('sendBtn');
        const inputWrapper = document.getElementById('inputWrapper');
        const imagePreview = document.getElementById('imagePreview');
        
        let messages = [];
        let pendingImages = [];
        
        function addMessage(text, type, images = []) {
            messages.push({ text, type, images });
            render();
        }
        
        function render() {
            if (messages.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }
            emptyState.style.display = 'none';
            
            const html = messages.map(m => {
                let content = escapeHtml(m.text);
                if (m.images && m.images.length > 0) {
                    content += m.images.map(img => '<img src="' + img + '" alt="image"/>').join('');
                }
                return '<div class="message ' + m.type + '">' + content + '</div>';
            }).join('');
            
            chat.innerHTML = html;
            chat.scrollTop = chat.scrollHeight;
        }
        
        function renderImagePreview() {
            imagePreview.innerHTML = pendingImages.map((img, i) => 
                '<div class="image-preview-item">' +
                    '<img src="' + img + '" alt="preview"/>' +
                    '<button class="remove-img" data-index="' + i + '">Ã—</button>' +
                '</div>'
            ).join('');
            
            imagePreview.querySelectorAll('.remove-img').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    pendingImages.splice(idx, 1);
                    renderImagePreview();
                });
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function handleImage(file) {
            if (!file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                pendingImages.push(e.target.result);
                renderImagePreview();
            };
            reader.readAsDataURL(file);
        }
        
        function send() {
            const text = input.value.trim();
            if (!text && pendingImages.length === 0) return;
            
            addMessage(text || '(image)', 'user', [...pendingImages]);
            vscode.postMessage({ command: 'submit', text: text, images: pendingImages });
            input.value = '';
            input.style.height = '44px';
            pendingImages = [];
            renderImagePreview();
        }
        
        sendBtn.addEventListener('click', send);
        
        // Settings for submit behavior (injected from VS Code)
        let enterToSubmit = true;
        let ctrlEnterToSubmit = false;
        
        input.addEventListener('keydown', (e) => {
            // Shift+Enter always creates a new line
            if (e.key === 'Enter' && e.shiftKey) {
                return; // Allow default behavior (new line)
            }
            
            // Ctrl+Enter (or Cmd+Enter on Mac) to submit
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey) && ctrlEnterToSubmit) {
                e.preventDefault();
                send();
                return;
            }
            
            // Enter to submit (without any modifiers)
            if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey && enterToSubmit) {
                e.preventDefault();
                send();
            }
        });
        
        input.addEventListener('input', () => {
            input.style.height = '44px';
            input.style.height = Math.min(input.scrollHeight, 360) + 'px';
            // Save input text to extension for persistence
            vscode.postMessage({ command: 'saveInput', text: input.value });
        });
        
        // Paste image support
        input.addEventListener('paste', (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    handleImage(item.getAsFile());
                }
            }
        });
        
        // Drag and drop support
        inputWrapper.addEventListener('dragover', (e) => {
            e.preventDefault();
            inputWrapper.classList.add('dragover');
        });
        
        inputWrapper.addEventListener('dragleave', () => {
            inputWrapper.classList.remove('dragover');
        });
        
        inputWrapper.addEventListener('drop', (e) => {
            e.preventDefault();
            inputWrapper.classList.remove('dragover');
            const files = e.dataTransfer?.files;
            if (files) {
                for (const file of files) {
                    handleImage(file);
                }
            }
        });
        
        function enableInput() {
            input.disabled = false;
            sendBtn.disabled = false;
            input.placeholder = 'Your feedback...';
            input.focus();
        }
        
        function disableInput() {
            input.disabled = true;
            sendBtn.disabled = true;
            input.placeholder = 'Waiting for request from agent...';
        }
        
        window.addEventListener('message', (event) => {
            const msg = event.data;
            if (msg.command === 'showPrompt') {
                // Only add message if it's not empty and not a restore (skipAddMessage)
                if (msg.message && msg.message.trim() && !msg.skipAddMessage) {
                    addMessage(msg.message, 'agent');
                }
                enableInput();
            } else if (msg.command === 'focus') {
                input.focus();
            } else if (msg.command === 'submitted') {
                disableInput();
            } else if (msg.command === 'config') {
                enterToSubmit = msg.enterToSubmit;
                ctrlEnterToSubmit = msg.ctrlEnterToSubmit;
            } else if (msg.command === 'restoreMessages') {
                // Restore messages from extension state
                messages = msg.messages || [];
                render();
            } else if (msg.command === 'enableInput') {
                enableInput();
            } else if (msg.command === 'restoreInput') {
                // Restore textarea input text
                input.value = msg.text || '';
                input.style.height = '44px';
                input.style.height = Math.min(input.scrollHeight, 360) + 'px';
            }
        });
        
        // Request initial config from extension
        vscode.postMessage({ command: 'ready' });
    </script>
</body>
</html>
